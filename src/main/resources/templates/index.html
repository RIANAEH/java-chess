<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>체스 미션</title>
    <link rel="stylesheet" href="/src/index.css">
</head>
<body>
<div id="app">
    <h1>엘리의 체스 게임</h1>
    <div class="menu">
        <span class="state"></span>
        <button id="startBtn" onclick="sendStart()">Start</button>
        <button id="EndBtn" onclick="sendEnd()">End</button>
        <button id="statusBtn" onclick="sendStatus()">Status</button>
    </div>
    <br/>
    <section class="chess-ui">
        <div id="a8" class="white-square" onclick="move(id)"></div>
        <div id="b8" class="black-square" onclick="move(id)"></div>
        <div id="c8" class="white-square" onclick="move(id)"></div>
        <div id="d8" class="black-square" onclick="move(id)"></div>
        <div id="e8" class="white-square" onclick="move(id)"></div>
        <div id="f8" class="black-square" onclick="move(id)"></div>
        <div id="g8" class="white-square" onclick="move(id)"></div>
        <div id="h8" class="black-square" onclick="move(id)"></div>

        <div id="a7" class="black-square" onclick="move(id)"></div>
        <div id="b7" class="white-square" onclick="move(id)"></div>
        <div id="c7" class="black-square" onclick="move(id)"></div>
        <div id="d7" class="white-square" onclick="move(id)"></div>
        <div id="e7" class="black-square" onclick="move(id)"></div>
        <div id="f7" class="white-square" onclick="move(id)"></div>
        <div id="g7" class="black-square" onclick="move(id)"></div>
        <div id="h7" class="white-square" onclick="move(id)"></div>

        <div id="a6" class="white-square" onclick="move(id)"></div>
        <div id="b6" class="black-square" onclick="move(id)"></div>
        <div id="c6" class="white-square" onclick="move(id)"></div>
        <div id="d6" class="black-square" onclick="move(id)"></div>
        <div id="e6" class="white-square" onclick="move(id)"></div>
        <div id="f6" class="black-square" onclick="move(id)"></div>
        <div id="g6" class="white-square" onclick="move(id)"></div>
        <div id="h6" class="black-square" onclick="move(id)"></div>

        <div id="a5" class="black-square" onclick="move(id)"></div>
        <div id="b5" class="white-square" onclick="move(id)"></div>
        <div id="c5" class="black-square" onclick="move(id)"></div>
        <div id="d5" class="white-square" onclick="move(id)"></div>
        <div id="e5" class="black-square" onclick="move(id)"></div>
        <div id="f5" class="white-square" onclick="move(id)"></div>
        <div id="g5" class="black-square" onclick="move(id)"></div>
        <div id="h5" class="white-square" onclick="move(id)"></div>

        <div id="a4" class="white-square" onclick="move(id)"></div>
        <div id="b4" class="black-square" onclick="move(id)"></div>
        <div id="c4" class="white-square" onclick="move(id)"></div>
        <div id="d4" class="black-square" onclick="move(id)"></div>
        <div id="e4" class="white-square" onclick="move(id)"></div>
        <div id="f4" class="black-square" onclick="move(id)"></div>
        <div id="g4" class="white-square" onclick="move(id)"></div>
        <div id="h4" class="black-square" onclick="move(id)"></div>

        <div id="a3" class="black-square" onclick="move(id)"></div>
        <div id="b3" class="white-square" onclick="move(id)"></div>
        <div id="c3" class="black-square" onclick="move(id)"></div>
        <div id="d3" class="white-square" onclick="move(id)"></div>
        <div id="e3" class="black-square" onclick="move(id)"></div>
        <div id="f3" class="white-square" onclick="move(id)"></div>
        <div id="g3" class="black-square" onclick="move(id)"></div>
        <div id="h3" class="white-square" onclick="move(id)"></div>

        <div id="a2" class="white-square" onclick="move(id)"></div>
        <div id="b2" class="black-square" onclick="move(id)"></div>
        <div id="c2" class="white-square" onclick="move(id)"></div>
        <div id="d2" class="black-square" onclick="move(id)"></div>
        <div id="e2" class="white-square" onclick="move(id)"></div>
        <div id="f2" class="black-square" onclick="move(id)"></div>
        <div id="g2" class="white-square" onclick="move(id)"></div>
        <div id="h2" class="black-square" onclick="move(id)"></div>

        <div id="a1" class="black-square" onclick="move(id)"></div>
        <div id="b1" class="white-square" onclick="move(id)"></div>
        <div id="c1" class="black-square" onclick="move(id)"></div>
        <div id="d1" class="white-square" onclick="move(id)"></div>
        <div id="e1" class="black-square" onclick="move(id)"></div>
        <div id="f1" class="white-square" onclick="move(id)"></div>
        <div id="g1" class="black-square" onclick="move(id)"></div>
        <div id="h1" class="white-square" onclick="move(id)"></div>
    </section>
</div>
<script>
    let source = "";
    let target = "";

    document.addEventListener("DOMContentLoaded", sendLoad);

    async function sendLoad() {
        await fetch("/load")
            .then(response => response.json())
            .then(data => {
                loadBoard(data.board);
                setState(data.state, data.turn);
            });
    }

    async function setState(state, turn) {
        document.getElementsByClassName('state')[0].textContent = state;
        console.log(turn);

        if (state === "Started") {
            document.getElementsByClassName('chess-ui')[0].style.visibility = 'visible';
            document.getElementsByClassName('state')[0].textContent += "(" + turn + ")";
        }
        if (state === "Ended") {
            alert("게임이 종료되었습니다.");
        }
    }

    async function sendStart() {
        await fetch("/start")
            .then(response => response.json())
            .then(data => {
                if (data.code === "success") {
                    loadBoard(data.board);
                    setState(data.state, data.turn);
                } else {
                    alert(data.message);
                }
            });
    }

    async function sendEnd() {
        await fetch("/end")
            .then(response => response.json())
            .then(data => {
                if (data.code === "success") {
                    loadBoard(data.board);
                    setState(data.state, data.turn);
                } else {
                    alert(data.message);
                }
            });
    }

    async function sendStatus() {
        await fetch("/status")
            .then(response => response.json())
            .then(data => {
                if (data.code === "success") {
                    alert(data.myTurn + " : " + data.myScore + "점\n"
                        + data.opponentTurn + " : " + data.opponentScore + "점\n"
                        + "당신(" + data.myTurn + ")은 " + data.result + "입니다.");
                } else {
                    alert(data.message);
                }
            });
    }

    async function move(id) {
        if (source === "") {
            source = id;
            document.getElementById(id).className += " selected";
            return;
        }
        if (source !== "" && target === "") {
            target = id;
            document.getElementById(id).className += " selected";
            await sendMove();
        }
    }

    async function sendMove() {
        const body = {
            source: source,
            target: target
        };

        await fetch("/move", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json;charset=utf-8',
                'Accept': 'application/json'
            },
            body: JSON.stringify(body)})
            .then(response => response.json())
            .then(data => {
                if (data.code === "success") {
                    loadBoard(data.board);
                    setState(data.state, data.turn);
                } else {
                    alert(data.message);
                }
                document.getElementById(source).classList.remove('selected');
                document.getElementById(target).classList.remove('selected');
            });

        source = "";
        target = "";
    }

    async function loadBoard(board) {
        for (key in board) {
            const div = document.getElementById(key);
            if (div.hasChildNodes()) {
                div.removeChild(div.firstChild);
            }
            if (board[key] !== "empty_none") {
                const img = document.createElement("img");
                img.src = "/images/" + board[key] + ".png";
                div.appendChild(img);
            }
        }
    }
</script>
</body>
</html>
